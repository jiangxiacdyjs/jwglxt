<title>消息中心</title>

<div class="layui-fluid" id="LAY-app-message">
  <div class="layui-card">
    <div class="layui-tab layui-tab-brief">
      <ul class="layui-tab-title">
        <li class="layui-this">全部消息</li>
        <li>通知公告<span class="layui-badge">6</span></li>
        <li>新闻动态</li>
        <div class="LAY-app-message-btns mt7 mr10 fr">
          <button data-events="add" class="layui-btn layui-btn-sm"><i class="layui-icon layui-icon-edit"></i>发布消息
          </button>
        </div>
      </ul>

      <div class="layui-tab-content">

        <div class="layui-tab-item layui-show">
          <div class="LAY-app-message-btns layui-btn-group mb10">
            <button data-type="all" data-events="del" class="layui-btn layui-btn-danger layui-btn-sm">删除所选</button>
            <button data-events="ready" class="layui-btn layui-btn-sm" data-type="all">标记已读</button>
            <button data-type="all" data-events="readyAll" class="layui-btn layui-btn-normal layui-btn-sm">全部已读</button>
          </div>
          <table id="LAY-app-message-all" lay-filter="LAY-app-message-all"></table>
        </div>
        <div class="layui-tab-item">

          <div class="LAY-app-message-btns" style="margin-bottom: 10px;">
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="notice" data-events="del">删除</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="notice" data-events="ready">标记已读
            </button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="notice" data-events="readyAll">全部已读
            </button>
          </div>

          <table id="LAY-app-message-notice" lay-filter="LAY-app-message-notice"></table>
        </div>
        <div class="layui-tab-item">

          <div class="LAY-app-message-btns" style="margin-bottom: 10px;">
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="direct" data-events="del">删除</button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="direct" data-events="ready">标记已读
            </button>
            <button class="layui-btn layui-btn-primary layui-btn-sm" data-type="direct" data-events="readyAll">全部已读
            </button>
          </div>
<div id="dom1"></div>
          <table id="LAY-app-message-news" lay-filter="LAY-app-message-news"></table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  layui.use(['admin', 'table', 'util'], function () {
    var $ = layui.$
      , admin = layui.admin
      , view = layui.view
      , table = layui.table
      , element = layui.element
      //区分各选项卡中的表格
      , tabs = {
        all: {
          text: '全部消息'
          , id: 'LAY-app-message-all'
        }
        , notice: {
          text: '通知公告'
          , id: 'LAY-app-message-notice'
        }
        , news: {
          text: '新闻动态'
          , id: 'LAY-app-message-news'
        }
      };

    //标题内容模板
    var tplTitle = function (d) {
      return '<a lay-href="system/message/detail/id=' + d.id + '">' + d.title;
    };

    //全部消息
    function renderTable(id, url){
      table.render({
        elem: '#'+id
        , url: admin.baseUrl + url //模拟接口
        , method: 'post'
        // 变相的通过设置skin为selectOnClick来配置点击行选中整行（此事件操作写在common.js中）
        // , skin: 'selectOnClick'
        , skin: 'line selectOnClick'
        , height:  admin.getRightAvailableHeight()-113
        , page: true
        , cols: [[
          {type: 'checkbox', fixed: 'left'}
          , {field: 'title', title: '标题内容', minWidth: 300, templet: tplTitle}
          , {field: 'time', title: '时间', width: 170}
        ]]
      });
    }

    renderTable('LAY-app-message-all', '/message');
    // renderTable('LAY-app-message-notice', '/message');
    // renderTable('LAY-app-message-news', '/message');

    //事件处理
    var events = {
      del: function (othis, type) {
        var thisTabs = tabs[type]
          , checkStatus = table.checkStatus(thisTabs.id)
          , data = checkStatus.data; // 获得选中的数据
        if (data.length === 0) return layer.msg('未选中行');

        var confirmLayerIdx = admin.popup({
          content: '是否确认删除已选择的' + data.length + '条数据？'
          , btn: ['确认', '取消']
          , skin: 'layui-layer-admin'
          , btnAlign: 'c'
          , yes: function (index, layero) {
            layer.close(confirmLayerIdx);
            $.ajax({
              type: 'post',
              url: admin.baseUrl + '/message',
              data: data,
              dataType: 'json',
              beforeSend: function () {
                this.loading = admin.loading();
              },
              complete: function () {
                layer.close(this.loading);
              },
              success: function (result) {
                if (result.code == 0) {
                  table.reload(thisTabs.id); //刷新表格
                }
              },
              error: function (error) {
                layer.msg('请求出错啦', {icon: 2});
              },
            });
          }
          , btn2: function (index, layero) {
          }
          , cancel: function () {
          }
        });
      }
      , ready: function (othis, type) {
        var thisTabs = tabs[type]
          , checkStatus = table.checkStatus(thisTabs.id)
          , data = checkStatus.data; //获得选中的数据
        if (data.length === 0) return layer.msg('未选中行');

        //此处只是演示
        layer.msg('标记已读成功', {
          icon: 1
        });
        table.reload(thisTabs.id); //刷新表格
      }
      , readyAll: function (othis, type) {
        var thisTabs = tabs[type];

        //do somethin

        layer.msg(thisTabs.text + '：全部已读', {
          icon: 1
        });
      }
      , add: function (othis, type) {
        admin.popup.addLayer = admin.popup({
          "title": "消息新增&nbsp;/&nbsp;编辑"
          , area: admin.screen() < 2 ? ['100%', '660px'] : ['880px', '660px']
          , id: 'messageAdd'//id唯一
          , maxmin: true //支持窗口最大化
          , shadeClose: false //支持窗口最大化
          , success: function () {
            view(this.id).render('system/message/message-layer').done(function (html) {
              if ($('button[lay-filter=resource-undo]').length) {
                $('button[lay-filter=resource-undo]').off('click').prop('type', 'reset').text('重置表单').trigger('click')
              }
            });
          }
        });
      }
    };

    $('.LAY-app-message-btns .layui-btn').on('click', function () {
      var othis = $(this)
        , thisEvent = othis.data('events')
        , type = othis.data('type');
      events[thisEvent] && events[thisEvent].call(this, othis, type);
    });
  });
</script>