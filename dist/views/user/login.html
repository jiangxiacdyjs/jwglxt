<script type="text/html" template>
  <link rel="stylesheet" href="{{ layui.setter.base }}style/login.css?v={{ layui.admin.v }}-1" media="all">
</script>
<div class="m-login-bg">
  <div class="m-bg-contain"></div>
  <div class="m-login">
    <h3 style="letter-spacing: 3px">营养餐管理系统登录</h3>
    <div class="m-login-warp">
      <form class="layui-form">
        <div class="layui-form-item">
          <input type="text" name="title" required lay-verify="title" placeholder="用户名" autocomplete="off"
                 class="layui-input">
        </div>
        <div class="layui-form-item">
          <input type="password" name="pwd" required lay-verify="pwd" placeholder="密码" autocomplete="off"
                 class="layui-input">
        </div>
        <div class="layui-form-item">
          <div class="layui-inline" style="width: 48%;float: left;margin-right: 4%">
            <input type="text" name="verity" required lay-verify="verity" placeholder="验证码" autocomplete="off"
                   class="layui-input">
          </div>
          <div class="layui-inline" style="width: 48%;float: left;margin-right: 0">
            <!--<img class="verifyImg" onclick="this.src=this.src+'?c='+Math.random();"
                 src="../src/img/login/yzm.jpg"/>-->
            <div style="height: 38px;margin:0 0 5px 0;border-radius: 2px;overflow: hidden">
              <div id="vContainer" style="width: inherit;height: inherit"></div>
            </div>
          </div>
        </div>
        <div class="layui-form-item m-login-btn">
          <div class="layui-inline" style="width: 48%;float: left;margin-right: 4%">
            <button type="reset" class="layui-btn layui-btn-primary">取消</button>
          </div>
          <div class="layui-inline fl" style="width: 48%;float: left;margin-right: 0">
            <button type="button" class="layui-btn" lay-submit lay-filter="LAY-user-login-submit">登录
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="layui-trans layui-form-item layadmin-user-login-other">
      <label>系统版本：</label><i class="layui-icon layui-icon-chart"></i><span>v2.0</span>
      <a lay-href="/user/reg" class="layadmin-user-jump-change layadmin-link">注册帐号</a>
    </div>
    <!--<p class="copyright">Copyright 2017-2018 by bd</p>-->
    <div class="ladmin-user-login-theme">
      <ul>
        <!--<li data-theme=""><img src="{{ layui.setter.base }}style/res/bg-none.jpg"></li>-->
        <li layadmin-event="setTheme" data-alias="default" data-index="0" title="default" class="layui-this">
          <div style="background-color: #20222A;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="dark-blue" data-index="1" title="dark-blue">
          <div style="background-color: #03152A;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="coffee" data-index="2" title="coffee">
          <div style="background-color: #2E241B;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="purple-red" data-index="3" title="purple-red">
          <div style="background-color: #7A4D7B;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="ocean" data-index="4" title="ocean">
          <div style="background-color: #1E9FFF;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="green" data-index="5" title="green">
          <div style="background-color: #2F9688;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="red" data-index="6" title="red">
          <div style="background-color: #F78400;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="fashion-red" data-index="7" title="fashion-red">
          <div style="background-color: #AA3130;"></div>
        </li>
        <li layadmin-event="setTheme" data-alias="classic-black" data-index="8" title="classic-black">
          <div style="background-color: #3A3D49;"></div>
        </li>
      </ul>
    </div>
  </div>
</div>
<script>
  layui.extend({
    verfiy: '{/} ../src/lib/extend/layui-gVerify' //{/}代表自有路径 验证码组件(在index.js中entryPage方法里，哈希路径改变后就动态的将扩展根目录设置在了controller文件夹下，因此这要单独配置路径)
  }).use(['admin', 'form', 'user', 'verfiy'], function () {
    var layer = layui.layer
      , $ = layui.$
      , setter = layui.setter
      , admin = layui.admin
      , form = layui.form
      , verfiy = layui.verfiy
      , router = layui.router()
      , search = router.search;

    // 页面特殊布局
    $('.m-login-bg').height($(window).height());
    $('.m-bg-contain').height($(window).height() / 2);

    // 验证码 todo:切换模块后验证码会显示不全，此问题有待解决
    var verifyCode = new verfiy({
      id: "vContainer",
      type: "number"
    });

    // 主题初始化
    var local = layui.data(setter.tableName);
    local.theme && admin.theme(local.theme);
    var $themeUl = $('.ladmin-user-login-theme').children('ul');
    var currentThemeIdx = local.theme ? local.theme.color.index : 0;
    var currentThemeLi = $themeUl.children('[data-index='+currentThemeIdx+']');
    var currentThemeColor = currentThemeLi.children().css('background-color');
    $('.m-bg-contain').css('background-color', currentThemeColor);
    $('button[lay-filter="LAY-user-login-submit"]').css('background-color', currentThemeColor);
    currentThemeLi.addClass('layui-this').siblings().removeClass('layui-this');
    // 设置主题(此处只是对本页进行特殊显示效果处理，另外还隐式触发了定义在admin.js里面的设置主题方法)
    $('.ladmin-user-login-theme').on('click', '[layadmin-event="setTheme"]', function () {
      var bgc = $(this).children().css('background-color');
      $('.m-bg-contain').css('background-color', bgc);
      $('button[lay-filter="LAY-user-login-submit"]').css('background-color', bgc);
    });

    // 表单初始化
    form.render();

    //自定义验证规则
    form.verify({
      title: function (value) {
        if (value.length < 2) {
          return '账号不得少于2字符';
        }
      },
      pwd: [/(.+){6,12}$/, '密码必须6到12位'],
      verity: function (value) {
        if (!verifyCode.validate(value)) {
          if($('input[name=verity]').length) $('input[name=verity]').val('');
          return '验证码不正确';
        };
      }
    });

    //监听提交
    form.on('submit(LAY-user-login-submit)', function (obj) {
      //请求登入接口
      admin.req({
        url: setter.baseUrl + '/postLogin' //实际使用请改成服务端真实接口
        , type: "post"
        , data: obj.field
        , done: function (res) {

          //请求成功后，写入 access_token
          layui.data(setter.tableName, {
            key: setter.request.tokenName
            , value: res.data.access_token
          });

          //登入成功的提示与跳转
          layer.msg(res.msg, {
            offset: '15px'
            , icon: 1
            , time: 1000
          }, function () {
            location.hash = search.redirect ? decodeURIComponent(search.redirect) : '/';
          });
        }
      });
      return false;
    });

    /*回车提交*/
    $(':input[name=verity]').keyup(function (event) {
      if (event.keyCode == "13") {
        $("button[lay-filter=LAY-user-login-submit]").trigger("click");
        return false;
      }
    });
  });
</script>